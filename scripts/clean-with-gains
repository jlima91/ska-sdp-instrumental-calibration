#!/usr/bin/env bash

#SBATCH --nodes=1
#SBATCH --exclusive
#SBATCH --no-requeue
#SBATCH --job-name=clean-with-gains
#SBATCH --output=slurm-%j-%x.out

export AWS_ENV=false
export DP3_CMD=${DP3_CMD:-"DP3"}
export WSCLEAN_CMD=${WSCLEAN_CMD:-"wsclean"}

export OPENBLAS_NUM_THREADS=1

check-module-load() {
   if [ "${AWS_ENV}" = true ]; then
     module list 2>&1 | grep -wq "ska-sdp-spack"
     if [[ $? -ne 0 ]]; then
       echo "Meta modules not loaded. Exiting"
       exit 1
     fi
   fi
}

help()
{
   # Display Help
   echo "Apply gaintable to measurement set using DP3, and generate fits image using wsclean"
   echo
   echo "Usage: clean-with-gains [-h][-a] -i <input-ms> -g <gaintable.h5parm> <WSCLEAN-PARAMS>"
   echo "options:"
   echo "h     Print this help and exit."
   echo "a     Set flag to run the script in AWS-HPC."
   echo
   echo "If -a flag is set, the script handles the module loads, and ensures DP3 and wsclean are in the execution path."
   echo "The user is required to load the metamodule on AWS-HPC"
   echo "If -a flag is not provided, the script assumes DP3 and wsclean to be in path and are defaulted to 'DP3' and 'wsclean'"
   echo "To use alternative DP3 command, set DP3_CMD=/alternate/path/to/DP3."
   echo "To use alternative wsclean command, set WSCLEAN_CMD=/alternate/path/to/wsclean."
   echo
}

create-fits() {
  if [ "${AWS_ENV}" = true ]; then
      module load --silent dp3 wsclean
  fi

  local wsclean_msin extra_args

  while [[ $# -gt 0 ]]; do
    case "$1" in
        -i)
            wsclean_msin="$2"
            shift 2
            ;;
        *)
            extra_args+=("$1")
            shift
            ;;
    esac
  done
  shift $((OPTIND-1))
  local wsclean_args="${extra_args[*]}"
  : ${wsclean_msin:?is not set. Use create-fits -i <input.ms>}

  set -o xtrace
  local beam_corrected_ms=./beamcor.ms
  ${DP3_CMD} msin=$wsclean_msin steps="[applybeam]" msout=$beam_corrected_ms
  ${WSCLEAN_CMD} -niter 0 -apply-primary-beam ${wsclean_args} $beam_corrected_ms
  rm -rf $beam_corrected_ms
  set +o xtrace

  if [ "${AWS_ENV}" = true ]; then
      module unload --silent dp3 wsclean
  fi
}

applycal() {
  if [ "${AWS_ENV}" = true ]; then
      module load --silent dp3
  fi

  local parmdb msin msout
  # Parse arguments
  while [[ "$#" -gt 0 ]]; do
    case "$1" in
      --parmdb)
        parmdb="$2"
        shift # Shift past the argument name
        ;;
      --msin)
        msin="$2"
        shift # Shift past the argument name
        ;;
      --msout)
        msout="$2"
        shift # Shift past the argument name
        ;;
      *)
        echo "Unknown option: $1"
        return 1
        ;;
    esac
    shift # Shift past the argument value or unknown option
  done

  echo "Removing previously created ${msout}"
  rm -rf $msout
  set -o xtrace
  ${DP3_CMD} steps="[applycal]" msin=${msin}\
      applycal.type=applycal applycal.parmdb=${parmdb}\
      applycal.updateweights=True\
      applycal.steps="[phase, amplitude]" applycal.phase.correction=phase000\
      applycal.amplitude.correction=amplitude000 msout=${msout}
  set +o xtrace

  if [ "${AWS_ENV}" = true ]; then
      module unload --silent dp3
  fi

}

MSOUT="corrected.ms"

while getopts ":hag:i:" option; do
   case $option in
     h) help
        exit;;
     g) PARMDB=$OPTARG;;
     i) MSIN=$OPTARG;;
     a) AWS_ENV=true;;
     \?) # Invalid option
        break;;

   esac
done
shift $((OPTIND-1))
WSCLEAN_ARGS=$@
: ${PARMDB:?is not set. Use -g <gaintbale.h5parm>}
: ${MSIN:?is not set. Use -i <input-ms.ms>}
: ${WSCLEAN_ARGS:?is not set. Please provide wsclean args}

check-module-load
# set -e

echo ""
echo "**************** wsclean without apply ***************"

create-fits -i $MSIN -name "original" ${WSCLEAN_ARGS}

echo ""
echo "**************** ApplyCal ***************"
applycal --parmdb $PARMDB --msin $MSIN --msout $MSOUT

echo ""
echo "**************** wsclean with apply ***************"

create-fits -i $MSOUT -name "corrected" ${WSCLEAN_ARGS}
